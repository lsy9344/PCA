# A 매장 쿠폰 적용 테스트 가이드

## 개요
참고 코드의 검증된 로직을 기반으로 A 매장 쿠폰 적용 기능을 테스트합니다.

## 주요 개선사항
1. **완전한 쿠폰 이력 조회**: 보유 쿠폰, 우리 매장 이력, 전체 이력 3개 테이블 모두 파싱
2. **강화된 쿠폰 적용 로직**: 확인 팝업 2단계 처리 포함
3. **향상된 팝업 처리**: 로그인 전후 모든 팝업 자동 처리
4. **상세한 로깅**: 각 단계별 성공/실패 상태 명확히 기록

## 테스트 실행 방법

### 1. 환경 준비
```bash
# 가상환경 활성화 (이미 설정되어 있다면 생략)
# Windows
venv\Scripts\activate

# 필요한 패키지 설치 확인
pip install -r requirements.txt
```

### 2. 테스트 실행
```bash
python test_a_store_coupon.py
```

### 3. 테스트 시나리오
테스트는 다음 순서로 진행됩니다:

1. **환경 설정**: A 매장 설정 로드 및 크롤러 초기화
2. **로그인 테스트**: 
   - 웹사이트 접속
   - 인트로/공지 팝업 자동 닫기
   - 로그인 수행
   - 로그인 후 팝업 처리
3. **차량 검색 테스트**:
   - 사용자 입력 차량번호로 검색
   - 검색 결과 확인 (없으면 테스트 중단)
   - 차량 선택 버튼 클릭
4. **쿠폰 이력 조회 테스트**:
   - 보유 쿠폰 현황 파싱
   - 우리 매장 적용 이력 파싱
   - 전체 적용 이력 파싱
5. **쿠폰 적용 테스트** (선택사항):
   - 보유 쿠폰 현황 표시
   - 사용자 확인 후 테스트 쿠폰 적용

## 테스트 결과 확인

### 성공 시 로그 예시
```
[테스트] ✅ 로그인 성공
[테스트] ✅ 차량 검색 성공: 12가3456
>>>>>[현재 적용 가능한 쿠폰]
30분할인권(무료): 2개
1시간할인권(유료): 1개
>>>>>[우리 매장에서 적용한 쿠폰]
30분할인권(무료): 0개
1시간할인권(유료): 0개
>>>>>[전체 적용된 쿠폰] (다른매장+우리매장)
30분할인권(무료): 1개
1시간할인권(유료): 0개
[테스트] ✅ 쿠폰 이력 조회 성공
[쿠폰적용] 30분할인권(무료) 적용 버튼 클릭
[쿠폰적용] 첫 번째 확인 팝업 처리 성공
[쿠폰적용] 두 번째 확인 팝업 처리 성공
[테스트] ✅ 쿠폰 적용 성공
```

### 실패 시 대응
- **로그인 실패**: 계정 정보 확인, 웹사이트 접속 상태 확인
- **차량 검색 실패**: 차량번호 정확성 확인, 주차장 이용 여부 확인
- **쿠폰 조회 실패**: 페이지 로딩 시간 확인, 셀렉터 변경 여부 확인
- **쿠폰 적용 실패**: 보유 쿠폰 수량 확인, 팝업 처리 로직 확인

## 주요 특징

### 참고 코드 기반 검증된 로직
- 실제 운영에서 검증된 A 매장 전용 로직 사용
- 모든 예외 상황에 대한 처리 포함
- 텔레그램 알림 연동 (오류 발생 시)

### 안전한 테스트 환경
- 실제 쿠폰 적용은 사용자 확인 후에만 진행
- 각 단계별 성공/실패 상태 명확히 표시
- 브라우저 자동 종료로 리소스 정리

## 문제 해결

### 자주 발생하는 문제
1. **ModuleNotFoundError**: Python 경로 설정 확인
2. **Playwright 오류**: `playwright install` 실행
3. **타임아웃 오류**: 네트워크 상태 및 웹사이트 응답 시간 확인
4. **셀렉터 오류**: 웹사이트 구조 변경 여부 확인

### 디버깅 팁
- `headless: false` 설정으로 브라우저 동작 직접 확인
- 로그 레벨을 DEBUG로 변경하여 상세 정보 확인
- 각 단계별로 스크린샷 저장 기능 활용

## 다음 단계
테스트가 성공적으로 완료되면:
1. 실제 운영 환경에 배포
2. 스케줄러 연동으로 자동 실행 설정
3. 모니터링 및 알림 시스템 구축 